# 2023年10月8日

## 实现子应用单独的alembic迁移管理结论

官方文档说可以支持，只是需要配置
https://alembic.sqlalchemy.org/en/latest/cookbook.html#multiple-environments

实际研究后发现官方的方案其实就是多数据库配置，对应的配置模板（alembic list_template）
中的 `multidb` 。

这种配置方式需要项目根目录放一个 `alembic.ini`，不需要迁移目录。然后里面配置各个子目录的
`alembic`迁移目录路径。

迁移的时候通过 `--name` 来指明迁移哪一个目录。

多个`alembic` 迁移目录创建迁移文件并不会在迁移文件中跨应用关联依赖。

举个例子：

apps/user 的迁移 01.py
apps/device 创建一个新的迁移， 02.py ，这时候02.py的 depends_on 不会设置为 01.py。因为 apps/device 根本不知道 apps/user 的存在。

由于数据库中只存在一个 `alembic_version` ，又因为多个`alembic` 迁移目录，而这些迁移目录之间没有形成依赖关系，再加上每次只能指明一个应用进行迁移：

```shell
alembic --name user upgrade head
```

当迁移了 user，alembic_version=01.py， 再迁移 device 就会爆出再device的迁移目录找不到 01.py 这个迁移文件的错误无法迁移。

也就是说 multidb 是真的为了多数据库 多环境迁移用的，无法模拟 django那样的每个应用自己维护自己的迁移的效果。


16点25分

经过一段时间的尝试和探索发现 `alembic` 的类似方案：

方案1： [Working with Multiple Bases](https://alembic.sqlalchemy.org/en/latest/branches.html#setting-up-multiple-version-directories)

这个方案的意思是允许我们将不同app模块的迁移文件放到不同的目录，但是使用同一份 `alembic.ini` 来管理，因此这些迁移文件的版本依赖是关联的。
虽然他们分散在不同的目录，但是他们实际上是由同一个`alembic.ini` 管理 `depends_on`关系。

这个方案明显是有点类似`django`的那个，但是只是解决了分散维护，没能实现插件式开发。
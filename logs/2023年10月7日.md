# 2023年10月7日

## 数据表的初始数据仍然需要

在国外数据库初始数据称之为 `seed data` 种子数据。

数据表创建的时候的 `seed` 数据（初始数据）仍然需要。比如部署后台的时候用户表中的管理员用户，其他表中的初始数据。

## Sqlalchemy/Alembic 不会自动帮用户创建数据库

官方人员说，数据库的创建应该是运维或者数据库管理员来做不应该是 `Sqlalchemy` 或者 `Alembic` 来做。

XXX: 所以我要怎么处理这个问题？

我的解决方案是模仿 `django` `ruby on rails` 增加一个 `seed` 机制。

`ruby on rails` 的做法是通过发现 `seeds.rb` 文件然后执行这个文件里的代码来实现填充数据库数据。
`seeds.rb` 文件中其实就是简简单单的调用了 `DAO` 或者 `ORM` 往数据库里安全的插入初始数据，仅此而已。

```ruby
# seeds.rb
User.find_or_create_by(name: 'John Doe', email: 'john@example.com', password: 'password')
```

而我通过发现 `__seed__.py` 文件执行里面的代码来填充数据库数据。

`__seed__.py` 文件中插入数据存在一些规范需要认为遵守：

1. 只新增，不允许修改和删除
2. 已经存在就不填充
3. 始终确保种子数据不违反任何数据库约束。
4. 使用 `first_or_create` 避免重复条目。

系统运行依赖数据存在，而不依赖数据正确。已经存在的数据行如果新增了字段应该由
`Alembic` 的字段默认值迁移来解决问题。

另外需要测试完`seed`后才在生产环境部署。 

除此之外 `seed` 文件的编写就很自由了，甚至可以用读配置的方式来加载种子数据。

## 后台的初始化部署流程

运维拿到我的项目源码后怎么一键部署。

像 `redmine` 它有三种部署方式：

**源码部署流程**

需要运维手动操作所有过程：
1. 手动创建数据库
2. 填写 `.env` 文件配置，设置好数据库连接串。
3. 守护进程启动后端


**Docker部署**

只需要填写 容器的环境变量参数即可，然后启动容器。

**windows安装包部署**

跟着安装程序向导走，设置好管理员用户名密码，他会配置.env并启动好MySql还有创建数据库。


我这里采用 `CLI` 来 `install` 部署。

XXX: 这里就存在一个问题，那就是这个 `CLI` 目前跟项目强耦合，不知道以后有没有可能剥离出来成为一个独立的工具。


## 暂时不考虑多租户问题

多租户架构的理解与设计本身就是个很麻烦的地方。目前先考虑单数据下怎么实现。

